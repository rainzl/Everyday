define(["require","exports","module","juicer"],function(e,t,n){var r=e("juicer"),i=Backbone.View.extend({options:{tpl:"",data:[],fetchUrl:"",initSize:6,commonSize:12,sWidth:1340,mWidth:1566},events:{"click .J_prev":"goPrev","click .J_next":"goNext","click .J_area":"loadArea"},initialize:function(){var e=this;this.lazy=!0,this.params={area:"all"},this.initIfInViewport();var t=_.bind(_.throttle(this.initIfInViewport,200),this),n=_.bind(_.throttle(this.resizeRender,0),this);$(window).scroll(function(){e.lazy&&t()}),$(window).resize(function(){e.lazy?t():n()})},initIfInViewport:function(){this.inViewport()&&(this.lazy=!1,this.adjustDimensions(),this.data=this.options.data,this.firstSize=this.initSize,this.start=0,this.end=this.getEnd(this.start),this.refreshElements(),this.$current=this.$sliderUl.find("li"),this.$firstRec=this.$current.find("div").eq(0),this.renderVideos(this.$current,this.data.slice(this.start,this.end)),this.showOrHideNext(),this.trigger("init"))},inViewport:function(){var e=$(window),t=this.$el.offset().top,n=this.$el.height();return e.height()+e.scrollTop()>=t&&e.scrollTop()<=t+n},resizeRender:function(){this.adjustDimensions(),this.$sliderUl.empty(),this.$current=this.addLi();var e=this.data.length-this.commonSize;e>0&&this.start>e&&(this.start=e),this.end=this.getEnd(this.start),this.renderVideos(this.$current,this.data.slice(this.start,this.end)).show(),this.showOrHidePre(),this.showOrHideNext()},adjustDimensions:function(){var e=this.options.commonSize/6,t=$("body").width();t<this.options.sWidth?(this.initSize=this.options.initSize-e*2,this.commonSize=this.options.commonSize-e*2):t<this.options.mWidth?(this.initSize=this.options.initSize-e,this.commonSize=this.options.commonSize-e):(this.initSize=this.options.initSize,this.commonSize=this.options.commonSize);var n=this.params&&this.params.area;this.options.special=="vchart"||!n||n=="all"?this.firstSize=this.initSize:this.firstSize=this.commonSize},refreshElements:function(){this.$prev=this.$el.find(".J_prev"),this.$next=this.$el.find(".J_next"),this.$sliderOverflow=this.$el.find(".index_list_auto"),this.$sliderUl=this.$sliderOverflow.find("ul"),this.$area=this.$el.find(".J_area")},renderVideos:function(e,t){var n=this,i=this.params&&this.params.area,s=this.options.special=="vchart"||!i||i=="all";s?(this.firstSize=this.initSize,this.start==0&&this.end<=this.initSize&&e.append(this.$firstRec)):this.firstSize=this.commonSize,e.append(r.to_html(this.options.tpl,{videos:t,_hmt:{channel:this.options.channel,areas:i,start:this.start}}));if(t.length>0){var o=0,u=Math.max(t.length-2,1);e.find("img").load(function(){$(this).next().show(),o++;if(o>u)return;o>=u&&(n.removeLoading(),n.$sliderUl.fadeIn())})}else n.removeLoading(),n.$sliderUl.fadeIn();return e},showOrHidePre:function(){var e=this.params&&this.params.area,t=this.options.special=="vchart"||!e||e=="all";t?this.start==0&&this.end<=this.initSize?this.$prev.hide():this.$prev.show():this.start==0?this.$prev.hide():this.$prev.show()},showOrHideNext:function(){this.end==this.data.length?this.$next.hide():this.$next.show()},goPrev:function(){if(this.sliding)return;var e=this.end=this.start,t=!1;this.end<this.commonSize&&(this.end=this.firstSize,t=!0),this.start=this.getStart(this.end);var n=this.$current,r=n.prev(),i=this.getEnd(this.start);r.length==0&&(r=this.addLi(!0),this.renderVideos(r,this.data.slice(this.start,this.end))),this.slideFx(n,r,"left",this.end-e,t),this.$next.show(),this.showOrHidePre()},goNext:function(){if(this.sliding)return;var e=this.start=this.end,t=this.data.length-this.commonSize,n=!1;this.start>t&&(this.start=t,n=!0),this.end=this.getEnd(this.start,this.commonSize);var r=this.$current,i=r.next();i.length==0&&(i=this.addLi(),this.renderVideos(i,this.data.slice(this.start,this.end))),this.slideFx(r,i,"right",e-this.start,n),this.$prev.show(),this.showOrHideNext()},slideFx:function(e,t,n,r,i){this.sliding=!0;var s=this,o=this.$sliderUl.width(),u=0,a=0,f=r>0?r*o/this.commonSize:0;this.$sliderOverflow.addClass("overflow"),n=="right"?a=-o+f:(u=-o+f,a=0),this.$sliderUl.css({width:o*2,"margin-left":u}),r>0&&(n=="right"?t.find(".mv_pic").slice(0,r).hide():e.find(".mv_pic").slice(0,r).hide()),t.show(),this.$sliderUl.stop(!0,!0).animate({"margin-left":a},800,function(){e.hide(),t.find(".mv_pic").show(),s.$sliderUl.css({"margin-left":0,width:""}),s.$sliderOverflow.removeClass("overflow"),s.$current=t,i&&s.$sliderUl.find(">li").not(s.$current).remove(),s.sliding=!1})},addLi:function(e){var t=$('<li class="index_list" style="display: none"></li>');return e?t.prependTo(this.$sliderUl):t.appendTo(this.$sliderUl)},getStart:function(e){var t=e-this.commonSize;return Math.max(t,0)},getEnd:function(e,t){if(!t)var t=e==0?this.firstSize:this.commonSize;return Math.min(e+t,this.data.length)},loadArea:function(e){var t=this,n=$(e.currentTarget);if(n.hasClass("cur"))return;this.$sliderUl.hide(),this.showLoading(),this.$area.removeClass("cur"),n.addClass("cur");var i=n.data("area");this.params.area=i,$.getJSON(this.options.fetchUrl,this.params,function(e){t.start=0,t.options.special=="vchart"?(i=="vspecial"?t.data=e.videos:t.data=e.videos.concat([{type:"trends",area:i.toUpperCase()},{type:"v",area:i.toUpperCase()}]),t.$firstRec=$(r.to_html($("#vchart_rec_tpl").html(),_.extend(e.rec,{area:i})))):t.data=e,t.$sliderUl.empty(),t.$current=t.addLi(),t.options.special=="vchart"||i=="all"?(t.firstSize=t.initSize,t.end=t.getEnd(t.start),t.$firstRec.appendTo(t.$current),t.renderVideos(t.$current,t.data.slice(t.start,t.end)).show()):(t.firstSize=t.commonSize,t.end=t.getEnd(t.start),t.renderVideos(t.$current,t.data.slice(t.start,t.end)).show()),t.showOrHidePre(),t.showOrHideNext(),t.trigger("loadArea",i)})},showLoading:function(){$('<span class="ico_loading"></span>').appendTo(this.$el)},removeLoading:function(){this.$el.find(".ico_loading").remove()}});n.exports=i});