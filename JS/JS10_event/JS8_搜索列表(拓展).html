<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
<style>
ul {
	margin: 0;
	padding: 0;
	list-style: none;
}
#wrap {
	position: relative;
	margin: 50px auto;
	width: 500px;
	height: 30px;
}
#wrap input {
	position: absolute;
	top: 0;
	left: 0;
	padding: 0 10px;
	width: 100%;
	height: 30px;
	border: 1px solid #ccc;
	box-sizing: border-box;
	outline: none;
}
#wrap ul {
	position: absolute;
	top: 30px;
	left: 0;
	width: 100%;
	border: 1px solid transparent;
	box-sizing: border-box;
}
#wrap li {
	height: 30px;
	border: 1px solid transparent;
	line-height: 30px;
	background-color: #5D9FC8;
	color: #333;
}
#wrap .active {
	background-color: #328FBE;
	border-color: #fff;
	color: #fff;
}
.show {
	display: block;
}
.hid {
	display: none;
}
#wrap .hover {
	background-color: #02A4C7;
	border-color: #ccc;
	color: #fff;
}
</style>
</head>
<body>
	<section id="wrap">
		<input type="text">
		<ul class="hid">
			<li>《汤姆叔叔的小屋   金庸》</li>
			<li>《红与黑   金庸》</li>
			<li>《战争年代   金庸》</li>
			<li>《沙哈拉的故事   三毛》</li>
			<li>《倾城之恋   张爱玲》</li>
			<li>《神笔马良   冰心》</li>
			<li>《JS权威指南   冰心》</li>
		</ul>
	</section>
<script src="JS/publicMain.js"></script>
<script>
(function(){
	var ipt = document.querySelector('#wrap input');
	var oUl = document.querySelector('#wrap ul');
	var aLis = Array.from(document.querySelectorAll('#wrap li'));
	
	var txt = [];
	var code = false;
	var index = -1;
	var timer = null;
	//先给每个元素加索引
	aLis.forEach(function(item,i){
		item.index = i;
	})
	
	//点击列表选项，调用chose函数
	oUl.onclick = function(ev){
		var ev = ev || event;
		chose(ev.target);
		ev.cancelBubble = true;
	}
	//鼠标移出取消列表上的样式
	oUl.onmouseover = function (ev) {
		var ev = ev || event;
		index == -1? index = 0: '';
		subClass(aLis[index],'hover');
		if ( ev.target.tagName == 'LI' ) {
			addClass(ev.target,'hover');
			index = ev.target.index;
		}
	}
	
	window.onkeydown = function(ev) {
		var ev = ev || event;
		code = ev.ctrlKey;
		
		if (ev.keyCode === 38) {
			index == -1? index = 0: ''; 
			subClass(aLis[index],'hover');
			index --;
			index = index< 0? aLis.length -1: index;
			addClass(aLis[index],'hover');
		} else if (ev.keyCode === 40) {
			index == -1? index = aLis.length -1: '';
			subClass(aLis[index],'hover');
			index ++;
			index = index > aLis.length -1? 0: index;
			addClass(aLis[index],'hover');
		} else if ( ev.keyCode === 13 ) {
			if ( index != -1 ){
				chose(aLis[index]);
			}
		}
	}
	window.onkeyup = function(ev) {//code变量，监控ctrl键是否同时按下
		var ev = ev || event;
		code = ev.ctrlKey;
	}
	ipt.onfocus = function() {//input获取焦点时，展示点选列表,被删除删除时，对应元素取消选中
		oUl.className = 'show';
		timer = setInterval(function(){
			var str = ipt.value;
			if (input(str)>=0) {
				aLis[input(str)].className = '';
			}
		},20);
	}
	ipt.onblur = function () {
		clearInterval(timer);
	}
	function input(str){
		
		for ( var i=0; i<txt.length; i++ ) {
			if (str.indexOf(txt[i].txt) == -1) {
				return txt[i].index;
			}
		}
		return -1;
	}
	window.addEventListener('click',close);//点击window隐藏点选列表
	
	ipt.onclick = function(ev) {//阻止输入框点击事件冒泡
		ev = ev || event;
		ev.cancelBubble = true;
	}
	
	function close() {
		if (index != -1) {
			aLis[index].className = '';
		}
		index = -1;//每次关闭列表，初始化列表索引为-1
		oUl.className = 'hid';
	}
	function chose(obj) {
		if ( !code ) {
			txt = [];
			aLis.forEach(function(item){
				item.className = '';
			})
			close();
		}
		if ( obj.tagName == 'LI' ) {
			obj.className = 'active';
			txt.push({'txt':obj.innerHTML,'index':obj.index});
		}
		var str = '';
		for ( var i=0; i<txt.length; i++ ) {
			str+=' '+txt[i].txt;
		}
		ipt.value = str;
		ipt.blur();
	}
	
})()
</script>
</body>
</html>
