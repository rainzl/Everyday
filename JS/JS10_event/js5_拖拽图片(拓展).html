<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
<style>
body {
	text-align: center;
}
input {
	cursor: pointer;
}
#box {
	position: relative;
	margin: 20px auto;
	text-align: center;
	padding: 10px 10px 0;
	width: 650px;
	border: 1px solid #00BFFF;
}
img {
	height: 123px;
	width: 200px;
	border: 5px dashed transparent;
	cursor: pointer;
	z-index: 1;
}
.red {
	border-color: #808080;
}
</style>
</head>
	
<body>
	<input value="随机排序" type="button" />
	<div id="box">
		<img src="img5/img1.gif" />
		<img src="img5/img2.gif" />
		<img src="img5/img3.gif" />
		<img src="img5/img4.gif" />
		<img src="img5/img5.gif" />
		<img src="img5/img6.gif" />
		<img src="img5/img7.gif" />
		<img src="img5/img8.gif" />
		<img src="img5/img9.gif" />
		<img src="img5/img10.gif" />
		<img src="img5/img11.gif" />
		<img src="img5/img12.gif" />
	</div>
<script src="JS/publicMain.js"></script>
<script>
(function(){
	var oBox = document.getElementById('box');
	var aImgs = Array.from(oBox.getElementsByTagName('img'));
	var btn = document.getElementsByTagName('input')[0];
	var arrPst = setPstArr();//存储每个元素的left和top
	var arrTemp = setPstArr();//存储每个元素的index
	setStyle(arrPst);
	aImgs.forEach(function(item,i){
		item.index = i;
		drag(item);
	})
	
	
	//点击随机切换
	btn.onclick = function () {
		arrTemp.sort(function(){ //对存储元素left和top的数组进行排序
			return Math.random() - 0.5;
		})
		setStyle(arrTemp);//给每个元素重新设置left和top值
	}
	
	//拖拽函数
	function drag(obj) {
		obj.addEventListener('mousedown',fnDown);
		function fnDown(ev) {
			var ev = ev || event;
			var disX = ev.pageX - this.offsetLeft,
				disY = ev.pageY - this.offsetTop;
			
			document.addEventListener('mousemove',fnMove);
			function fnMove(ev) {
				var ev = ev || event;
				var t = ev.pageY - disY,
					l = ev.pageX - disX;
				
				obj.style.top = t + 'px';
				obj.style.left = l + 'px';
				moveDo(obj);
			}
			document.addEventListener('mouseup',fnUp);
			function fnUp() {
				document.removeEventListener('mousemove',fnMove);
				document.removeEventListener('mouseup',fnUp);
				upDo(obj);
			}
			ev.preventDefault();
		}
	}
	//鼠标移动需要执行的函数
	function moveDo(obj) {
		obj.style.zIndex = 10;
		var otherObj = findNear(obj);
		
		if (otherObj) {
			aImgs.forEach(function(item){//清空上一张的样式
				item.className = '';
			})
			if (otherObj) {
				otherObj.className = 'red';
				var start = obj.index,
				end = otherObj.index;
				if ( start>end ) {
					for ( var i=0; i<aImgs.length; i++ ) {
						if ( aImgs[i].index<start && aImgs[i].index>=end ) {
							aImgs[i].index++;
							mTween(aImgs[i],{'top':arrPst[aImgs[i].index].t,'left':arrPst[aImgs[i].index].l},100,'linear');
						}
					}
				} else {
					for ( var i=0; i<aImgs.length; i++ ) {
						if ( aImgs[i].index>start && aImgs[i].index<=end ) {
							aImgs[i].index--;
							mTween(aImgs[i],{'top':arrPst[aImgs[i].index].t,'left':arrPst[aImgs[i].index].l},100,'linear');
						}
					}
				}
				obj.index = end;
				if (otherObj.nextElementSibling) {
					obj.parentNode.insertBefore(obj,otherObj.nextElementSibling);
				} else {
					obj.parentNode.appendChild(obj);
				}
			}
		}
	}
	//鼠标抬起需要执行的函数
	function upDo(obj) {
		var otherObj = findNear(obj);
		
		obj.style.zIndex = 1;
		if (otherObj){
			otherObj.className = '';
			var start = obj.index,
				end = otherObj.index;
			if ( start>end ) {
				for ( var i=0; i<aImgs.length; i++ ) {
					if ( aImgs[i].index<start && aImgs[i].index>=end ) {
						aImgs[i].index++;
						mTween(aImgs[i],{'top':arrPst[aImgs[i].index].t,'left':arrPst[aImgs[i].index].l},100,'linear');
					}
				}
			} else {
				for ( var i=0; i<aImgs.length; i++ ) {
					if ( aImgs[i].index>start && aImgs[i].index<=end ) {
						aImgs[i].index--;
						mTween(aImgs[i],{'top':arrPst[aImgs[i].index].t,'left':arrPst[aImgs[i].index].l},100,'linear');
					}
				}
			}
			
			obj.index = end;
			if (otherObj.nextElementSibling) {
				obj.parentNode.insertBefore(obj,otherObj.nextElementSibling);
			} else {
				obj.parentNode.appendChild(obj);
			}
		}
		mTween(obj,{'top':arrPst[obj.index].t,'left':arrPst[obj.index].l},100,'linear');
	}
	//查询最近的一个元素
	function findNear(obj) {
		var min = 1000;
		var minIndex = -1;
		var otherObj = null;
		for ( var i=0; i<aImgs.length; i++ ) {
			if ( aImgs[i] == obj ) {
				continue;
			} else if ( collision(obj,aImgs[i]) && min > minNum(obj,aImgs[i]) ) {
				min = minNum(obj,aImgs[i]);
				minIndex = aImgs[i].index;
			}
		}
		if (minIndex>=0) {
			for ( var i=0; i<aImgs.length; i++ ) {
				if (aImgs[i].index == minIndex) {
					otherObj = aImgs[i];
				}
			}
		}
		return otherObj;
	}
	//计算两个元素间中心点的距离
	function minNum(obj1,obj2) {
		var num = Math.sqrt(Math.pow((obj1.offsetLeft - obj2.offsetLeft),2)+Math.pow((obj1.offsetTop - obj2.offsetTop),2));
		return num;
	}
	//根据数组中的数据，设置每个元素的top和left值
	function setStyle(arr) {
		aImgs.forEach(function(item,i){
			item.style.position = 'absolute';
			mTween(item,{'left':arr[i].l,'top':arr[i].t},400,'linear');
		});
	}
	
	//初始化，将每个元素的top和left值存入数组
	function setPstArr(){
		var arr = [];
		oBox.style.height = oBox.clientHeight + 'px';
		for ( var i=0; i<aImgs.length; i++ ) {
			arr.push({'l':aImgs[i].offsetLeft,'t':aImgs[i].offsetTop});
		}
		return arr;
	}
})()
</script>
</body>
</html>
