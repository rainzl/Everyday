<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
<style>
body {
	text-align: center;
}
canvas {
	display: block;
	margin: 20px auto;
	background-color: #ccc;
}
</style>
</head>
<body>
	<input type="file" value="上传图片" accept="image/jpeg" />
	<canvas width="0" height="0"></canvas>
<script>
(function(d){
	var btn = d.getElementsByTagName('input')[0],
		c = d.getElementsByTagName('canvas')[0];
	var cxt = c.getContext('2d');
	var num = 50;
	
	
	
	btn.onchange = function (ev) {
		var ev = ev || event;
		
		var fReader = new FileReader;
		fReader.readAsDataURL(ev.target.files[0]);
		fReader.onload = function (){
			var src = this.result;
			var img = document.createElement('img');
			img.src = src;
			c.width = img.width;
			c.height = img.height;
			img.onload = function (){
				cxt.drawImage(this,0,0,c.width,c.height);
				var data = cxt.getImageData(0,0,c.width,c.height);
				var newData = cxt.createImageData(c.width,c.height);
				cxt.clearRect(0,0,c.width,c.height);
				cxt.putImageData(newData,0,0);
				var arr = randArr(data);//对应图片的每一像素
				randNum(newData,data,arr);
			}
		}
	}
	function randNum(newData,data,arr) {
		var now = 0;
		var countNum = Math.ceil(arr.length/num);
		var timer = setInterval(
			function(){
				console.time(1);
				if ( now > num ) {
					clearInterval(timer);
				} else {
					for ( var i=0; i<countNum; i++ ) {
						var x = arr[i]%data.width,
							y = parseInt(arr[i]/data.width);
						var color = getImg(data,x,y);
						setImg(newData,x,y,color)
						
						arr.shift(i);
					}
					cxt.putImageData(newData,0,0);
					now++;
				}
				console.timeEnd(2);
			},20
		);
	}
	function setImg(data,x,y,color) {
		var numTemp = y*data.width + x;
		data.data[numTemp*4] = color[0];
		data.data[numTemp*4+1] = color[1];
		data.data[numTemp*4+2] = color[2];
		data.data[numTemp*4+3] = color[3];
	}
	function getImg(data,x,y) {
		var numTemp = y*data.width + x;
		var color = [];
		color[0] = data.data[numTemp*4];
		color[1] = data.data[numTemp*4+1];
		color[2] = data.data[numTemp*4+2];
		color[3] = data.data[numTemp*4+3];
		return color;
	}
	function randArr(data) {
		var arrRan = [];
		for ( var i=0; i<data.width*data.height; i++ ) {
			arrRan.push(i);
		}
		arrRan.sort(function(){
			return Math.random() - 0.5;
		});
		return arrRan;
	}
	
})(document)
</script>
</body>
</html>
